# CD IM Chat Server

这是一个极简的一对一 WebSocket 聊天服务端，配合浏览器扩展使用。

## 目录结构

- `server.js`：主程序
- `package.json`：依赖声明（仅使用 `ws` 一个库）

## 本地测试运行

1. 在这台机器上安装 Node.js（版本 18 以上）。
2. 打开命令行，进入本目录（`server`）。
3. 执行：

   ```bash
   npm install
   npm start
   ```

4. 服务默认监听在端口 `3000`。

   - WebSocket 地址示例：`ws://127.0.0.1:3000`
   - 浏览器扩展里把服务器地址设置为上面的 WebSocket 地址即可。

## 部署到外部主机

你也可以选择任何支持运行 Node.js 的免费或自建主机，只要满足：

- 能执行 `npm install` 和 `node server.js`；
- 对外开放一个端口（例如 80、443、3000 等）；
- 把环境变量 `PORT` 设置为平台分配给你的端口（如果需要）。

大致步骤：

1. 在远程主机上创建一个目录，把 `server` 这个文件夹里的内容上传过去。
2. 进入该目录，运行：

   ```bash
   npm install
   npm start
   ```

   或者按平台要求配置启动命令为：

   ```bash
   node server.js
   ```

3. 得到实际对外访问地址，例如：

   ```text
   ws://你的域名:端口
   或
   wss://你的域名
   ```

4. 在浏览器扩展的设置里，把“服务器地址（WebSocket）”填写为对应的 `ws://` 或 `wss://` 地址即可。

## 工作原理（简述）

- 客户端连接上来后发送一条 `{type: "hello", pairId, userId, displayName}` 消息完成“加入房间”。
- 服务器按 `pairId` 把两个用户放到同一个房间里，保存在线连接和最近少量历史消息。
- 聊天时发送 `{type: "chat", text, pairId, userId, clientMsgId}`，服务器生成时间戳和消息 ID，并广播给这个房间中所有在线用户。
- 如果连接断开，客户端会自动重连；重连成功后会收到最近一部分历史。

服务器仅把消息保存在内存中，重启后历史会清空，如果需要真正长期保存聊天记录，可以在这个基础上再扩展为数据库存储。
